<div
  *ngIf="{
    sampleAllocations: sampleAllocations$ | async,
    multipleResultsAttributeType: multipleResultsAttributeType$ | async
  } as params"
>
  <mat-toolbar color="primary"
    >Result entry & Review -
    <span class="ml-4" *ngIf="!data?.LISConfigurations?.isLIS">
      <span
        >Patient:
        {{ data?.sample?.patient?.givenName }}
        {{ data?.sample?.patient?.midllename }}
        {{ data?.sample?.patient?.familyName }} | </span
      >Gender: <b>{{ data?.sample?.patient?.gender }}</b> | Age:
      <b>{{ data?.sample?.patient?.age }} Yrs</b>
    </span>
    <span class="ml-2"> - {{ data?.sample?.label }} </span>
  </mat-toolbar>
  <div class="p-3">
    <div style="max-height: 75vh; overflow: auto">
      <div class="loading-overlay" *ngIf="saving">
        <div class="text-center">
          <div>Saving ....</div>
          <div class="mt-3 d-flex justify-content-center w-100">
            <mat-spinner diameter="50" strokeWidth="2"></mat-spinner>
          </div>
        </div>
      </div>
      <app-shared-error
        *ngIf="errors?.length > 0"
        [errors]="errors"
      ></app-shared-error>
      <table
        class="table table-bordered"
        *ngIf="!errors || errors?.length == 0"
      >
        <tbody>
          <ng-container *ngFor="let order of params?.sampleAllocations">
            <tr>
              <td
                *ngIf="params?.sampleAllocations[0]?.allocations[0]?.isSet"
                [ngStyle]="{
                  'width:': params?.sampleAllocations[0]?.allocations[0]?.isSet
                    ? '100px'
                    : '30%'
                }"
              >
                {{ order?.concept?.display }}
              </td>
              <td>
                <div class="row">
                  <div
                    [ngClass]="{
                      'parameter-test-default':
                        (allocationData?.allocation?.parameter?.datatype.name ==
                          'Numeric' ||
                          allocationData?.allocation?.parameter?.datatype
                            .name == 'Coded') &&
                        allocationData?.allocation?.isSet,
                      'parameter-test-text':
                        allocationData?.allocation?.parameter?.datatype.name !=
                          'Numeric' &&
                        allocationData?.allocation?.parameter?.datatype.name !=
                          'Coded' &&
                        allocationData?.allocation?.isSet,
                      'col-12': !allocationData?.allocation?.isSet
                    }"
                    class="entry-col"
                    *ngFor="let allocationData of order?.allocations"
                  >
                    <div class="w-100 ml-2">
                      {{ allocationData?.allocation?.parameter?.display }}
                    </div>
                    <div class="w-100">
                      <app-test-parameter-entry
                        [parameterUuid]="
                          allocationData?.allocation?.parameter?.uuid
                        "
                        [multipleResultsAttributeType]="
                          params?.multipleResultsAttributeType
                        "
                        [allocation]="allocationData?.allocation"
                        (data)="
                          onGetFieldData(
                            $event,
                            allocationData?.allocation?.parameter,
                            allocationData?.allocation
                          )
                        "
                      ></app-test-parameter-entry>
                    </div>
                  </div>
                </div>
              </td>
              <td style="width: 100px">
                <div class="mt-4">
                  <button
                    [disabled]="!isFormValid"
                    mat-flat-button
                    color="primary"
                    (click)="onSave($event, order)"
                  >
                    Save
                  </button>
                </div>
                <div class="mt-4 d-flex justify-content-end">
                  <button
                    *ngIf="shouldConfirm"
                    class="mr-2"
                    mat-stroked-button
                    (click)="onCancelAuthorize($event)"
                  >
                    Cancel
                  </button>
                  <button
                    *ngIf="
                      (!data?.LISConfigurations?.isLIS &&
                        order?.authorizationStatuses?.length === 0) ||
                      (data?.LISConfigurations?.isLIS &&
                        order?.authorizationStatuses?.length === 0)
                    "
                    mat-flat-button
                    color="primary"
                    (click)="
                      onAuthorize($event, order?.allocations, shouldConfirm)
                    "
                  >
                    {{ !shouldConfirm ? "Authorize" : "Confirm" }}
                  </button>
                  <span
                    color="primary"
                    *ngIf="
                      (data?.LISConfigurations?.isLIS &&
                        order?.authorizationStatuses?.length > 0) ||
                      (!data?.LISConfigurations?.isLIS &&
                        order?.authorizationStatuses?.length > 1)
                    "
                    ><b
                      >Authorized
                      <span *ngIf="!data?.LISConfigurations?.isLIS"
                        >(Second Approval)</span
                      ></b
                    ></span
                  >
                </div>
              </td>
              <td *ngIf="!data?.LISConfigurations?.isLIS">
                <div class="mt-4 d-flex justify-content-end">
                  <button
                    *ngIf="shouldConfirm"
                    class="mr-2"
                    mat-stroked-button
                    (click)="onCancelAuthorize($event)"
                  >
                    Cancel
                  </button>
                  <button
                    *ngIf="
                      !data?.LISConfigurations?.isLIS &&
                      order?.authorizationStatuses?.length === 0
                    "
                    mat-flat-button
                    color="primary"
                    (click)="
                      onAuthorize(
                        $event,
                        order?.allocations,
                        shouldConfirm,
                        'SECOND_APPROVAL'
                      )
                    "
                  >
                    {{ !shouldConfirm ? "Authorize" : "Confirm" }}
                  </button>
                  <span
                    color="primary"
                    *ngIf="
                      !data?.LISConfigurations?.isLIS &&
                      order?.secondAuthorizationStatuses?.length > 1
                    "
                    ><b
                      >Authorized
                      <span *ngIf="!data?.LISConfigurations?.isLIS"
                        >(Second Approval)</span
                      ></b
                    ></span
                  >
                </div>
              </td>
            </tr>
            <tr>
              <td colspan="100%" class="text-muted test-order-description">
                <em>
                  Ordered By:
                  <b>
                    {{ order?.orderer?.name }}
                  </b>
                </em>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
    <div class="d-flex justify-content-end">
      <button (click)="onClose($event)" mat-stroked-button>Close</button>
    </div>
  </div>
</div>
