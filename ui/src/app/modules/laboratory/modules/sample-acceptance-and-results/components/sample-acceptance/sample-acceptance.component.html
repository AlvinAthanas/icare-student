<div
  class="sample-acceptance-and-results"
  *ngIf="{
    samplesToAccept: samplesToAccept$ | async,
    providerDetails: providerDetails$ | async,
    settingLabSampleStatus: settingLabSampleStatus$ | async,
    allSamples: allSamples$ | async,
    worklist: worklist$ | async,
    labDepartments: labDepartments$ | async,
    samplesToFeedResults: samplesToFeedResults$ | async,
    completedSamples: completedSamples$ | async,
    patientsWithCompletedSamples: patientsWithCompletedSamples$ | async,
    rejectedSamples: rejectedSamples$ | async,
    acceptedSamples: acceptedSamples$ | async,
    samplesWithResults: samplesWithResults$ | async,
    patientsWithResults: patientsWithResults$ | async,
    samplesLoadedState: samplesLoadedState$ | async
  } as sampleParams"
>
  <div class="loading-overlay" *ngIf="saving">
    <div class="text-center">
      <div>Saving ....</div>
      <div class="mt-3 d-flex justify-content-center w-100">
        <mat-spinner diameter="50" strokeWidth="2"></mat-spinner>
      </div>
    </div>
  </div>
  <mat-tab-group (selectedTabChange)="onOpenNewTab($event)">
    <mat-tab label="Sample Acceptance">
      <ng-template matTabContent>
        <div class="p-2">
          <app-samples-to-accept
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-samples-to-accept>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Accepted Samples">
      <ng-template matTabContent>
        <div class="p-2">
          <app-accepted-samples
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-accepted-samples>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Rejected at Registration">
      <ng-template matTabContent>
        <div class="p-2">
          <app-rejected-samples
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-rejected-samples>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Rejected at Laboratory">
      <ng-template matTabContent>
        <div class="p-2">
          <app-samples-rejected-after-registration
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-samples-rejected-after-registration>
        </div>
      </ng-template>
    </mat-tab>

    <mat-tab label="Worklist">
      <ng-template matTabContent>
        <div class="p-2">
          <app-worklist
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-worklist>
        </div>
      </ng-template>
    </mat-tab>

    <mat-tab label="Worksheets" *ngIf="LISConfigurations?.isLIS">
      <ng-template matTabContent>
        <div class="p-3">
          <app-worksheets [datesParameters]="datesParameters"></app-worksheets>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab
      label="Results Entry {{ !LISConfigurations?.isLIS ? '& Approval' : '' }}"
    >
      <ng-template matTabContent>
        <div class="p-2">
          <app-samples-for-results-entry
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-samples-for-results-entry>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab
      label="Results Review & Authorization"
      *ngIf="LISConfigurations?.isLIS"
    >
      <ng-template matTabContent>
        <div class="p-2">
          <app-samples-for-results-entry
            [tabType]="'REVIEW_AND_AUTHORIZATION'"
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [category]="'HAS_RESULTS'"
            [hasStatus]="'YES'"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-samples-for-results-entry>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Completed Samples">
      <ng-template matTabContent>
        <div class="p-2">
          <app-completed-samples
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          ></app-completed-samples>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab *ngIf="showTabSampleTrackingForLis" label="Sample Tracking">
      <ng-template matTabContent>
        <div class="filter-and-legend">
          <mat-form-field class="w-50">
            <mat-label>Search</mat-label>
            <mat-icon matPrefix>search</mat-icon
            ><input
              matInput
              (keyup)="onSearch($event)"
              [(ngModel)]="searchingText"
            />
          </mat-form-field>

          <table
            style="border: none; margin-left: 15px"
            class="w-20 float-right"
          >
            <tr style="height: 30px">
              <td style="width: 40px; border: solid 1px #eee"></td>
              <td>
                <div style="margin-left: 3px; margin-right: 20px">
                  No results filled
                </div>
              </td>
              <td
                style="
                  background-color: #ec864acf;
                  width: 40px;
                  margin-left: 20px;
                "
              ></td>
              <td>
                <div style="margin-left: 3px; margin-right: 20px">
                  Has results
                </div>
              </td>
              <td
                style="width: 40px; margin-left: 20x"
                [ngStyle]="{
                  'background-color': !LISConfigurations?.isLIS
                    ? '#f5f171f7'
                    : '#0080009e'
                }"
              ></td>
              <td>
                <div style="margin-left: 3px; margin-right: 20px">
                  {{
                    !LISConfigurations?.isLIS
                      ? "Waiting second approval"
                      : "Authorized"
                  }}
                </div>
              </td>
              <td
                *ngIf="LISConfigurations?.isLIS"
                style="
                  background-color: #d04747ab;
                  width: 40px;
                  margin-left: 20px;
                "
              ></td>
              <td *ngIf="LISConfigurations?.isLIS">
                <div style="margin-left: 3px">Has Amended results</div>
              </td>

              <td
                *ngIf="!LISConfigurations?.isLIS"
                style="
                  background-color: #d04747ab;
                  width: 40px;
                  margin-left: 20px;
                "
              ></td>
              <td *ngIf="!LISConfigurations?.isLIS">
                <div style="margin-left: 3px">Has rejected results</div>
              </td>

              <td
                *ngIf="!LISConfigurations?.isLIS"
                style="
                  background-color: #6fd67bcf;
                  width: 40px;
                  margin-left: 20px;
                "
              ></td>
              <td *ngIf="!LISConfigurations?.isLIS">
                <div style="margin-left: 3px">Completed</div>
              </td>
            </tr>
          </table>

          <mat-form-field appearance="fill" class="w-30 ml-2 float-right">
            <mat-label
              >Select
              {{
                !LISConfigurations?.isLIS ? "Department" : "Section"
              }}</mat-label
            >
            <mat-select [(value)]="selectedDepartment">
              <mat-option (click)="setDepartment('')">All</mat-option>
              <mat-option
                *ngFor="let dept of sampleParams?.labDepartments"
                [value]="dept?.display"
                (click)="setDepartment(dept?.display)"
              >
                {{ dept?.display }}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
        <div class="p-1">
          <table class="table table-bordered">
            <thead class="table-header">
              <tr>
                <th rowspan="2">SN</th>
                <th rowspan="2">Department</th>
                <th rowspan="2">Sample / Specimen</th>
                <th rowspan="2">Laboratory ID</th>
                <th rowspan="2" *ngIf="!LISConfigurations?.isLIS">MRN</th>
                <th rowspan="2" *ngIf="!LISConfigurations?.isLIS">
                  Patient Names
                </th>
                <th colspan="2" class="text-center">Test details</th>
                <th rowspan="2" *ngIf="LISConfigurations?.isLIS">
                  Received By
                </th>
                <th rowspan="2" *ngIf="LISConfigurations?.isLIS">
                  Received On
                </th>
                <th rowspan="2">
                  {{
                    !LISConfigurations?.isLIS ? "Collected By" : "Registered By"
                  }}
                </th>
                <th rowspan="2">
                  {{
                    !LISConfigurations?.isLIS ? "Collected On" : "Registered On"
                  }}
                </th>
                <th rowspan="2">Priority</th>
                <th rowspan="2">Action</th>
              </tr>
              <tr>
                <th>Test Order</th>
                <th>Ordered By</th>
                <!-- <th>Source</th>
              <th>Date Ordered</th> -->
              </tr>
            </thead>
            <tbody>
              <ng-container *ngIf="sampleParams?.allSamples?.length > 0">
                <ng-container
                  *ngFor="
                    let sample of sampleParams?.allSamples;
                    let count = index
                  "
                >
                  <tr
                    [ngStyle]="{
                      'background-color': sample?.completed
                        ? '#6fd67bcf'
                        : sample?.atLestOneOrderWithRejectedResults &&
                          !sample?.completed
                        ? '#d04747ab'
                        : order?.testAllocations[0]?.firstSignOff &&
                          !LISConfigurations?.isLIS
                        ? '#f5f171f7'
                        : order?.testAllocations[0]?.firstSignOff &&
                          LISConfigurations?.isLIS
                        ? '#0080009e'
                        : sample?.atLeastOneHasResults && !sample?.completed
                        ? '#ec864acf'
                        : ''
                    }"
                    *ngFor="let order of sample?.orders; let orderCount = index"
                    [ngClass]="{ 'row-alternated': count % 2 !== 0 }"
                  >
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ count + 1 }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.department?.departmentName }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.specimen?.specimenName }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.label }}
                    </td>
                    <td
                      *ngIf="orderCount == 0 && !LISConfigurations?.isLIS"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.mrn }}
                    </td>
                    <td
                      *ngIf="orderCount == 0 && !LISConfigurations?.isLIS"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.patient?.givenName }}
                      {{ sample?.patient?.middleName }}
                      {{ sample?.patient?.familyName }}
                    </td>
                    <td>
                      {{ order?.order?.concept?.display.replace("TO:", "") }}
                    </td>
                    <td>{{ order?.order?.orderer?.name }}</td>
                    <!-- <td>{{ order?.order?.location?.name }}</td>
                  <td>{{ order?.order?.orderDate | date: "medium" }}</td> -->
                    <td
                      *ngIf="orderCount == 0 && LISConfigurations?.isLIS"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.receivedByStatus?.user?.name }}
                    </td>
                    <td
                      *ngIf="orderCount == 0 && LISConfigurations?.isLIS"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{
                        sample?.receivedOnStatus?.timestamp
                          ? (sample?.receivedOnStatus?.remarks | date: "medium")
                          : ""
                      }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.collectedBy?.display }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{ sample?.created | date: "medium" }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      {{
                        !LISConfigurations?.isLIS
                          ? sample?.priorityHigh
                            ? "Urgent"
                            : "Routine"
                          : sample?.priorityStatus?.status
                          ? sample?.priorityStatus?.status
                          : "Routine"
                      }}
                    </td>
                    <td
                      *ngIf="orderCount == 0"
                      [attr.rowspan]="sample?.orders?.length"
                    >
                      <button
                        class="colored-button"
                        mat-button
                        (click)="
                          onResultsReview(
                            $event,
                            sample,
                            sampleParams?.providerDetails
                          )
                        "
                      >
                        View
                      </button>
                    </td>
                  </tr>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="sampleParams?.allSamples?.length == 0">
                <tr>
                  <td colspan="14" class="text-danger text-center">
                    No samples
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab
      label="Authorized Results"
      *ngIf="LISConfigurations?.isLIS == 'test'"
    >
      <ng-template matTabContent>
        <div class="filter-and-legend">
          <mat-form-field class="w-50">
            <mat-label>Search</mat-label>
            <mat-icon matPrefix>search</mat-icon
            ><input
              matInput
              (keyup)="onSearch($event)"
              [(ngModel)]="searchingText"
            />
          </mat-form-field>
        </div>
        <div class="p-1">
          <table class="table table-bordered">
            <thead>
              <tr>
                <th style="width: 10px !important">SN</th>
                <th>
                  {{
                    !LISConfigurations?.isLIS ? "Pantient ID" : "Reference ID"
                  }}
                </th>
                <th>
                  {{
                    !LISConfigurations?.isLIS
                      ? "Patient names"
                      : "Reference Names"
                  }}
                </th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="
                  let patient of sampleParams?.patientsWithCompletedSamples;
                  let count = index
                "
              >
                <td>
                  {{ count + 1 }}
                </td>
                <td>
                  {{ patient?.mrn }}
                </td>
                <td>
                  {{ patient?.patient?.givenName }}
                  {{ patient?.patient?.middleName }}
                  {{ patient?.patient?.familyName }}
                </td>
                <td>
                  <button
                    class="colored-button"
                    mat-stroked-button
                    (click)="
                      onResultsToPrint(
                        $event,
                        patient,
                        sampleParams?.providerDetails
                      )
                    "
                  >
                    Print results
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Results" *ngIf="LISConfigurations?.isLIS">
      <ng-template matTabContent>
        <div class="filter-and-legend">
          <mat-form-field class="w-50">
            <mat-label>Search</mat-label>
            <mat-icon matPrefix>search</mat-icon
            ><input
              matInput
              (keyup)="onSearch($event)"
              [(ngModel)]="searchingText"
            />
          </mat-form-field>
        </div>

        <mat-progress-bar
          mode="indeterminate"
          *ngIf="!sampleParams?.samplesLoadedState"
        ></mat-progress-bar>
        <div class="p-1" *ngIf="sampleParams?.samplesLoadedState">
          <table class="table table-bordered">
            <thead>
              <tr>
                <!-- <th style="width: 10px !important">SN</th> -->
                <th>Patient Identification Number</th>
                <th>Department</th>
                <th>LAB ID/No.</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <ng-container>
                <ng-container
                  *ngFor="
                    let patient of sampleParams?.patientsWithResults;
                    let pCount = index
                  "
                >
                  <ng-container
                    *ngFor="
                      let department of patient?.departments;
                      let dCount = index
                    "
                  >
                    <tr
                      *ngFor="
                        let sample of department?.samples;
                        let sCount = index
                      "
                    >
                      <!--
                    <td
                    > 
                      *ngIf="pCount == 0"
                      [attr.rowspan]="patient?.departments?.length"
                      {{ count + 1 }}
                    </td> -->
                      <td>
                        {{ patient?.mrn }}
                      </td>
                      <td>
                        {{
                          department?.departmentName &&
                          department?.departmentName !== "undefined"
                            ? department?.departmentName
                            : "Not set"
                        }}
                      </td>
                      <td>
                        {{ sample?.id }}
                      </td>
                      <td>
                        <button
                          class="colored-button"
                          mat-stroked-button
                          (click)="
                            onResultsToPrint(
                              $event,
                              patient,
                              sampleParams?.providerDetails,
                              sample?.authorizationInfo?.length > 0
                            )
                          "
                        >
                          Preview Report
                        </button>

                        <button
                          class="colored-button ml-2"
                          mat-stroked-button
                          (click)="onReviewResults($event, patient, sample)"
                        >
                          Review
                        </button>
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-template>
    </mat-tab>
    <mat-tab label="Sample Tracking" *ngIf="!LISConfigurations?.isLIS">
      <ng-template matTabContent>
        <div class="p-2">
          <app-sample-tracking-list
            [codedSampleRejectionReasons]="params?.codedSampleRejectionReasons"
            [labConfigs]="labConfigs"
            [datesParameters]="datesParameters"
            [LISConfigurations]="LISConfigurations"
            [patients]="patients"
            [sampleTypes]="sampleTypes"
            [labSamplesDepartments]="labSamplesDepartments"
            [labSamplesContainers]="labSamplesContainers"
            [userUuid]="userUuid"
          >
          </app-sample-tracking-list>
        </div>
      </ng-template>
    </mat-tab>
  </mat-tab-group>
</div>
