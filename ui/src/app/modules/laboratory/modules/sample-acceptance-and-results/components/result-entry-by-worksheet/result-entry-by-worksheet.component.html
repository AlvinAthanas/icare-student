<div
  class="w-100"
  *ngIf="{
    currentWorksheetDefinition: currentWorksheetDefinition$ | async
  } as params"
>
  <div>
    <app-form
      [fields]="[worksheetDefinitionField]"
      (formUpdate)="onFormUpdate($event)"
    ></app-form>
  </div>

  <mat-progress-bar
    mode="indeterminate"
    *ngIf="
      !params?.currentWorksheetDefinition && currentWorksheetDefinitionUuid
    "
  ></mat-progress-bar>
  <div class="loading-overlay" *ngIf="savingData">
    <div class="text-center">
      <div>Saving details...</div>
      <div class="mt-3 d-flex justify-content-center w-100">
        <mat-spinner diameter="50" strokeWidth="2"></mat-spinner>
      </div>
    </div>
  </div>
  <div class="row" *ngIf="params?.currentWorksheetDefinition">
    <div class="col-12 d-flex justify-content-end">
      <mat-radio-group>
        <mat-radio-button
          [value]="'hide'"
          [checked]="remarksShowStatus === 'hide'"
          color="primary"
          (change)="getRemarksShowStatus($event)"
          >Hide remarks</mat-radio-button
        >
        <mat-radio-button
          [value]="'show'"
          [checked]="remarksShowStatus === 'show'"
          color="primary"
          class="ml-3"
          (change)="getRemarksShowStatus($event)"
          >Show remarks</mat-radio-button
        >
      </mat-radio-group>
    </div>
    <div class="col-md-4">
      <table class="table table-bordered">
        <ng-container
          *ngFor="
            let worksheetSample of params?.currentWorksheetDefinition
              ?.groupedWorksheetSamples?.group1
          "
        >
          <tr>
            <td style="width: 50px">
              {{ worksheetSample?.sample?.display }}
            </td>
            <td style="width: 50px">
              <div class="w-100">
                <ng-container
                  *ngFor="
                    let allocation of worksheetSample?.sample?.allocations
                  "
                >
                  <app-test-parameter-entry
                    *ngIf="
                      allocation?.order?.concept?.setMembers?.length == 0 ||
                      (allocation?.order?.concept?.setMembers?.length > 0 &&
                        allocation?.order?.concept?.uuid !==
                          allocation?.parameter?.uuid)
                    "
                    [parameterUuid]="allocation?.parameter?.uuid"
                    [allocation]="allocation"
                    [multipleResultsAttributeType]="
                      multipleResultsAttributeType
                    "
                    [isLIS]="isLIS"
                    [disabled]="false"
                    [finalResult]="allocation?.finalResult"
                    [conceptNameType]="conceptNameType"
                    (data)="
                      getFedResult(
                        $event,
                        worksheetSample?.sample,
                        allocation,
                        params?.currentWorksheetDefinition
                      )
                    "
                  ></app-test-parameter-entry>
                </ng-container>
              </div>
            </td>
          </tr>
          <tr *ngIf="showRemarks">
            <td colspan="2">
              <app-shared-remarks-entry
                (remarks)="onGetRemarks($event, allocation)"
              ></app-shared-remarks-entry>
            </td>
          </tr>
        </ng-container>
      </table>
    </div>
    <div class="col-md-4">
      <table class="table table-bordered">
        <ng-container
          *ngFor="
            let worksheetSample of params?.currentWorksheetDefinition
              ?.groupedWorksheetSamples?.group2
          "
        >
          <tr>
            <td style="width: 50px">
              {{ worksheetSample?.sample?.display }}
            </td>
            <td style="width: 50px">
              <div class="w-100">
                <ng-container
                  *ngFor="
                    let allocation of worksheetSample?.sample?.allocations
                  "
                >
                  <app-test-parameter-entry
                    *ngIf="
                      allocation?.order?.concept?.setMembers?.length == 0 ||
                      (allocation?.order?.concept?.setMembers?.length > 0 &&
                        allocation?.order?.concept?.uuid !==
                          allocation?.parameter?.uuid)
                    "
                    [parameterUuid]="allocation?.parameter?.uuid"
                    [allocation]="allocation"
                    [multipleResultsAttributeType]="
                      multipleResultsAttributeType
                    "
                    [isLIS]="isLIS"
                    [disabled]="false"
                    [finalResult]="allocation?.finalResult"
                    [conceptNameType]="conceptNameType"
                    (data)="
                      getFedResult(
                        $event,
                        worksheetSample?.sample,
                        allocation,
                        params?.currentWorksheetDefinition
                      )
                    "
                  ></app-test-parameter-entry>
                </ng-container>
              </div>
            </td>
          </tr>
          <tr *ngIf="showRemarks">
            <td colspan="2">
              <app-shared-remarks-entry
                (remarks)="onGetRemarks($event, allocation)"
              ></app-shared-remarks-entry>
            </td>
          </tr>
        </ng-container>
      </table>
    </div>
    <div class="col-md-4">
      <table class="table table-bordered">
        <ng-container
          *ngFor="
            let worksheetSample of params?.currentWorksheetDefinition
              ?.groupedWorksheetSamples?.group3
          "
        >
          <tr>
            <td style="width: 50px">
              {{ worksheetSample?.sample?.display }}
            </td>
            <td style="width: 50px">
              <div class="w-100">
                <ng-container
                  *ngFor="
                    let allocation of worksheetSample?.sample?.allocations
                  "
                >
                  <app-test-parameter-entry
                    *ngIf="
                      allocation?.order?.concept?.setMembers?.length == 0 ||
                      (allocation?.order?.concept?.setMembers?.length > 0 &&
                        allocation?.order?.concept?.uuid !==
                          allocation?.parameter?.uuid)
                    "
                    [parameterUuid]="allocation?.parameter?.uuid"
                    [allocation]="allocation"
                    [multipleResultsAttributeType]="
                      multipleResultsAttributeType
                    "
                    [isLIS]="isLIS"
                    [disabled]="false"
                    [finalResult]="allocation?.finalResult"
                    [conceptNameType]="conceptNameType"
                    (data)="
                      getFedResult(
                        $event,
                        worksheetSample?.sample,
                        allocation,
                        params?.currentWorksheetDefinition
                      )
                    "
                  ></app-test-parameter-entry>
                </ng-container>
              </div>
            </td>
          </tr>
          <tr *ngIf="showRemarks">
            <td colspan="2">
              <app-shared-remarks-entry
                (remarks)="onGetRemarks($event, allocation)"
              ></app-shared-remarks-entry>
            </td>
          </tr>
        </ng-container>
      </table>
    </div>
  </div>
  <div class="w-100 d-flex justify-content-end">
    <button
      mat-flat-button
      color="primary"
      (click)="onSave($event)"
      [disabled]="!isFormValid"
    >
      Save
    </button>
  </div>
</div>
