<div
  class="w-100"
  *ngIf="{
    currentWorksheetDefinition: currentWorksheetDefinition$ | async
  } as params"
>
  <div>
    <app-form
      [fields]="[worksheetDefinitionField]"
      (formUpdate)="onFormUpdate($event)"
    ></app-form>
  </div>

  <mat-progress-bar
    mode="indeterminate"
    *ngIf="
      !params?.currentWorksheetDefinition && currentWorksheetDefinitionUuid
    "
  ></mat-progress-bar>
  <div class="loading-overlay" *ngIf="savingData">
    <div class="text-center">
      <div>Saving details...</div>
      <div class="mt-3 d-flex justify-content-center w-100">
        <mat-spinner diameter="50" strokeWidth="2"></mat-spinner>
      </div>
    </div>
  </div>
  <div class="row" *ngIf="params?.currentWorksheetDefinition">
    <div class="col-md-6">
      <mat-form-field class="w-50">
        <mat-label>Search</mat-label>
        <mat-icon matPrefix>search</mat-icon
        ><input
          type="text"
          placeholder="Search"
          matInput
          [(ngModel)]="searchingText"
        />
      </mat-form-field>
    </div>
    <div class="col-md-6 d-flex justify-content-end">
      <mat-radio-group>
        <mat-radio-button
          [value]="'hide'"
          [checked]="remarksShowStatus === 'hide'"
          color="primary"
          (change)="getRemarksShowStatus($event)"
          >Hide remarks</mat-radio-button
        >
        <mat-radio-button
          [value]="'show'"
          [checked]="remarksShowStatus === 'show'"
          color="primary"
          class="ml-3"
          (change)="getRemarksShowStatus($event)"
          >Show remarks</mat-radio-button
        >
      </mat-radio-group>
    </div>
    <div class="col-md-12" style="width: 100%; overflow: auto">
      <table class="table table-bordered table-striped">
        <thead>
          <tr class="text-center">
            <th style="width: 40px" class="text-center">SN</th>
            <th style="width: 10%">Age</th>
            <th style="width: 10%">Gender</th>
            <th style="width: 10%">Lab No</th>
            <th
              [attr.colspan]="
                params?.currentWorksheetDefinition?.worksheetSamples[0]
                  ?.allocationsCount
              "
            >
              Parameters
            </th>
            <th *ngIf="showRemarks" style="width: 20%">Remarks</th>
            <th style="width: 30px"></th>
          </tr>
        </thead>
        <ng-container
          *ngFor="
            let worksheetSample of params?.currentWorksheetDefinition
              ?.worksheetSamples | searchItem: searchingText;
            let count = index
          "
        >
          <tr>
            <td class="text-center">
              {{ count + 1 }}
            </td>
            <td>{{ worksheetSample?.patient?.age }}</td>
            <td>{{ worksheetSample?.patient?.gender }}</td>
            <td style="width: 50px">
              {{ worksheetSample?.sample?.display }}
            </td>
            <td
              style="width: 30px"
              *ngFor="let allocation of worksheetSample?.sample?.allocations"
            >
              <div class="w-100">
                <ng-container>
                  <app-test-parameter-entry
                    *ngIf="
                      allocation?.order?.concept?.setMembers?.length == 0 ||
                      (allocation?.order?.concept?.setMembers?.length > 0 &&
                        allocation?.order?.concept?.uuid !==
                          allocation?.parameter?.uuid)
                    "
                    [parameterUuid]="allocation?.parameter?.uuid"
                    [allocation]="allocation"
                    [multipleResultsAttributeType]="
                      multipleResultsAttributeType
                    "
                    [isLIS]="isLIS"
                    [disabled]="false"
                    [finalResult]="allocation?.finalResult"
                    [conceptNameType]="conceptNameType"
                    (data)="
                      getFedResult(
                        $event,
                        worksheetSample?.sample,
                        allocation,
                        params?.currentWorksheetDefinition
                      )
                    "
                  ></app-test-parameter-entry>
                </ng-container>
              </div>
            </td>
            <td *ngIf="showRemarks">
              <app-shared-remarks-entry
                (remarks)="onGetRemarks($event, allocation)"
              ></app-shared-remarks-entry>
            </td>
            <td></td>
          </tr>
        </ng-container>
      </table>
    </div>
  </div>
  <div class="w-100 d-flex justify-content-end">
    <button
      mat-flat-button
      color="primary"
      (click)="onSave($event)"
      [disabled]="!isFormValid"
    >
      Save
    </button>
  </div>
</div>
