<div>
  <div
    class="row"
    *ngIf="{
      sampleTypes: sampleTypes$ | async,
      labSamplesAndTestsContainers: labSamplesAndTestsContainers$ | async,
      labSamplesDepartments: labSamplesDepartments$ | async,
      codedSampleRejectionReasons: codedSampleRejectionReasons$ | async,
      providerDetails: providerDetails$ | async
    } as params"
  >
    <div class="col-md-2 col-sx-12 col-sm-12 no-print">
      <div class="h3 p-3 text-muted" style="border-bottom: solid 1px #eee">
        Reports list
      </div>
      <ul class="list-group" style="margin-top: 5px">
        <li
          class="list-group-item"
          [ngClass]="{
            'active-menu':
              currentReport?.id === report?.id &&
              (!report?.members ||
                (report?.members && report?.members?.length == 0))
          }"
          *ngFor="let report of reports"
        >
          <a
            class="p-2"
            (click)="onSetCurrentReport($event, report)"
            [ngStyle]="{
              'margin-bottom':
                report?.members && report?.members?.length >= 0
                  ? '10px !important'
                  : '2px'
            }"
          >
            {{ report?.name }}
            <span
              (click)="onToggleSubMenus($event, report, report?.members)"
              *ngIf="
                report?.members &&
                report?.members?.length >= 0 &&
                !showSubMenu[report?.id]
              "
              style="float: right"
            >
              <i
                class="fa fa-angle-down"
                style="font-weight: 600; font-size: 1.4rem"
              ></i>
            </span>
            <span
              (click)="onToggleSubMenus($event, report, report?.members)"
              *ngIf="
                report?.members &&
                report?.members?.length >= 0 &&
                showSubMenu[report?.id]
              "
              style="float: right"
            >
              <i
                class="fa fa-angle-up"
                style="font-weight: 600; font-size: 1.4rem"
              ></i>
            </span>
          </a>
          <div
            style="margin-left: 15px; margin-top: 20px"
            *ngIf="
              report?.members &&
              report?.members?.length >= 0 &&
              showSubMenu[report?.id]
            "
          >
            <ul class="list-group">
              <li
                *ngFor="let member of report?.members"
                [ngClass]="{
                  'active-menu': currentReport?.id === member?.id
                }"
                class="list-group-item-header list-group-item text-left"
                (click)="onSetCurrentReport($event, member)"
              >
                <a class="p-1">
                  {{ member?.name }}
                </a>
              </li>
            </ul>
          </div>
        </li>
      </ul>
    </div>
    <div class="col-md-10 col-sx-12 col-sm-12 report">
      <div class="w-100 d-flex justify-content-left no-print">
        <div style="width: auto">
          <mat-button-toggle-group
            name="fontStyle"
            (change)="onSelectPeriod($event)"
          >
            <mat-button-toggle value="ToDay">Today</mat-button-toggle>

            <mat-button-toggle value="ThisWeek">This Week</mat-button-toggle>
            <!-- <mat-button-toggle value="LastSevenDays"
            >Last 7 days</mat-button-toggle
          > -->
            <mat-button-toggle value="ThisMonth">This Month</mat-button-toggle>
            <mat-button-toggle value="ThisYear">This year</mat-button-toggle>
          </mat-button-toggle-group>
        </div>

        <div class="w-25">
          <mat-form-field
            appearance="fill"
            class="ml-2 mt-1"
            floatLabel="always"
          >
            <mat-label>Enter a date range</mat-label>
            <mat-date-range-input [rangePicker]="picker">
              <input
                matStartDate
                placeholder="Start date"
                [(ngModel)]="startDate"
                (dateInput)="dateRangeSelect()"
              />
              <input
                matEndDate
                placeholder="End date"
                [(ngModel)]="endDate"
                (dateInput)="dateRangeSelect()"
              />
            </mat-date-range-input>
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-date-range-picker #picker></mat-date-range-picker>
          </mat-form-field>
        </div>
      </div>
      <div class="w-100 d-flex justify-content-end mt-1 mb-2">
        <button
          (click)="onDownloadCSV($event)"
          mat-stroked-button
          color="primary"
        >
          CSV
        </button>
        <button
          (click)="onPrint($event)"
          class="ml-2"
          mat-stroked-button
          color="primary"
        >
          Print
        </button>
      </div>
      <mat-card class="border">
        <div *ngIf="currentReport?.hardCoded">
          <mat-progress-bar
            mode="indeterminate"
            *ngIf="loadingReport"
          ></mat-progress-bar>
          <div
            *ngIf="!selectionDates || !reportData"
            class="d-flex justify-content-center text-muted align-items-center"
            style="min-height: 400px"
          >
            Select Period to view results
          </div>
          <div
            *ngIf="selectionDates"
            id="container"
            style="min-height: 400px; padding: 2%"
          >
            <div class="p-3 h3 text-center" *ngIf="reportData">
              <div class="row" *ngIf="facilityDetails$ | async as facility">
                <div class="col-2" style="display: inline-block; width: 16.67%">
                  <img src="assets/images/udsm-logo.webp" height="90" />
                  <!-- <img src="assets/images/tanzania-logo.png" height="90" /> -->
                </div>
                <div class="col-8" style="display: inline-block; width: 66.67%">
                  <h4 style="text-align: center">
                    <b
                      >United Republic of Tanzania. <br />
                      Ministry of Health.
                      <br />
                     <!-- <span *ngIf="labConfigs?.facilityDetails">
                        {{ labConfigs?.facilityDetails?.name }}<br />
                      </span> -->
                      <span *ngIf="facility.display">
                        {{ facility.display }}<br />
                      </span>
                     <small>
                    <!-- <span
                      *ngIf="
                        labConfigs?.facilityDetails &&
                        labConfigs?.facilityDetails?.addressBox
                      ">P.O BOX: {{ labConfigs?.facilityDetails?.addressBox }}</span> -->
                        <span
                          *ngIf="
                            facility &&
                            facility.postalCode
                          "
                        >
                          P.O BOX: {{ facility.postalCode }}
                        </span>
                        <!-- <span
                          *ngIf="
                            labConfigs?.facilityDetails &&
                            labConfigs?.facilityDetails?.addressTel
                          "
                        >
                          TEL: {{ labConfigs?.facilityDetails?.addressTel }}
                        </span>  -->
                        </small
                      ><br />
                      <small>
                        <span
                          *ngIf="
                            facility &&
                            facility.stateProvince
                          "
                        >
                          {{ facility.stateProvince }}
                        </span>
                        <!-- <span
                          *ngIf="
                            labConfigs?.facilityDetails &&
                            labConfigs?.facilityDetails?.addressLocaton
                          "
                        >
                          {{ labConfigs?.facilityDetails?.addressLocaton }}
                        </span> -->
                      </small>
                    </b>
                  </h4>
                </div>
              </div>
              <div class="h5 text-center">
                {{ currentReport?.description }}
              </div>
              <div
                class="d-flex float-left w-100"
                *ngIf="currentReport?.showSearching"
              >
                <mat-form-field class="w-50" style="font-size: 0.9rem">
                  <mat-label>Search</mat-label>
                  <mat-icon matPrefix>search</mat-icon
                  ><input
                    type="text"
                    placeholder="Search"
                    matInput
                    [(ngModel)]="searchingText"
                  />
                </mat-form-field>
              </div>
            </div>
            <div *ngIf="currentReport?.id == 'TAT' && reportData">
              <table
                style="border: none; margin-left: 15px"
                class="w-20 float-right"
              >
                <tr style="height: 20px">
                  <td
                    style="
                      background-color: 'green';
                      width: 40px;
                      margin-left: 20px;
                    "
                  ></td>
                  <td>
                    <div style="margin-left: 3px; margin-right: 20px">
                      No deviation
                    </div>
                  </td>
                  <td
                    style="
                      width: 40px;
                      background-color: 'red';
                      margin-left: 20x;
                    "
                  ></td>
                  <td>
                    <div style="margin-left: 3px; margin-right: 20px">
                      There is deviation
                    </div>
                  </td>
                </tr>
              </table>
              <table class="table table-bordered" id="export-table">
                <thead>
                  <tr style="background-color: #669999">
                    <td>Test</td>
                    <td>Department</td>
                    <td>Specimen source</td>
                    <td>Expected TAT (MINS)</td>
                    <td>Expected TAT (HRS)</td>
                    <td>Urget TAT (MINS)</td>
                    <td>Urget TAT (HRS)</td>
                    <td>Actual TAT (MINS)</td>
                    <td>Actual TAT (HRS)</td>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let dataRow of reportData">
                    <td>{{ dataRow?.test }}</td>
                    <td>{{ dataRow?.department }}</td>
                    <td>{{ dataRow?.specimen_source }}</td>
                    <td>{{ dataRow?.standard_tat }}</td>
                    <td>{{ dataRow?.standard_tat_hrs }}</td>
                    <td>{{ dataRow?.urgent_tat }}</td>
                    <td>{{ dataRow?.urgent_tat_hrs }}</td>
                    <td
                      [ngStyle]="{
                        'background-color':
                          dataRow?.standard_tat <= dataRow?.standard_tat
                            ? 'green'
                            : dataRow?.standard_tat > dataRow?.standard_tat
                            ? 'red'
                            : ''
                      }"
                    >
                      {{ dataRow?.tat }}
                    </td>
                    <td
                      [ngStyle]="{
                        'background-color':
                          dataRow?.standard_tat <= dataRow?.standard_tat
                            ? 'green'
                            : dataRow?.standard_tat > dataRow?.standard_tat
                            ? 'red'
                            : ''
                      }"
                    >
                      {{ dataRow?.tat_hrs }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="currentReport?.id == 'samples' && reportData">
              <div>
                <table class="table table-bordered" id="export-table">
                  <thead class="table-header">
                    <tr>
                      <th>Number/Statuses</th>
                      <th>COLLECTED</th>
                      <th>ACCEPTED</th>
                      <th>REJECTED</th>
                      <th>RECOLLECTED</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Count by status</td>
                      <td>
                        {{ reportData["status"]?.collected }}
                      </td>
                      <td>
                        {{ reportData["status"]?.accepted }}
                      </td>
                      <td>
                        {{ reportData["status"]?.rejected }}
                      </td>
                      <td>
                        {{ reportData["status"]?.recollected }}
                      </td>
                    </tr>
                    <tr class="table-header text-center">
                      <th rowspan="2">Specimen/Status</th>
                      <th colspan="4">STATUSES</th>
                    </tr>
                    <tr class="table-header text-center">
                      <th>COLLECTED</th>
                      <th>ACCEPTED</th>
                      <th>REJECTED</th>
                      <th>RECOLLECTED</th>
                    </tr>
                    <tr *ngFor="let specimen of specimenSources">
                      <td>
                        {{ specimen }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.collected[specimen][0]
                            ?.count
                        }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.accepted[specimen]
                            ? reportData["bySpecimenSouces"]?.accepted[
                                specimen
                              ][0]?.count
                            : 0
                        }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.rejected[specimen]
                            ? reportData["bySpecimenSouces"]?.rejected[
                                specimen
                              ][0]?.count
                            : 0
                        }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.recollected[specimen]
                            ? reportData["bySpecimenSouces"]?.recollected[
                                specimen
                              ][0]?.count
                            : 0
                        }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="currentReport?.parent == 'tests' && reportData">
              <div>
                <table class="table table-bordered" id="export-table">
                  <ng-container
                    *ngIf="currentReport?.id == 'tests-by-specimen-sources'"
                  >
                    <tr class="table-header">
                      <th>Number/Statuses</th>
                      <th>Ordered</th>
                      <th>Completed</th>
                      <th>In Progress</th>
                      <th>% Completed</th>
                    </tr>
                    <tr>
                      <td>Count by status</td>
                      <td>
                        {{ reportData["status"]?.ordered }}
                      </td>
                      <td>
                        {{ reportData["status"]?.performed }}
                      </td>
                      <td>
                        {{
                          reportData["status"]?.ordered -
                            reportData["status"]?.performed
                        }}
                      </td>
                      <td>
                        {{
                          (
                            (reportData["status"]?.performed /
                              reportData["status"]?.ordered) *
                            100
                          ).toFixed(1)
                        }}
                      </td>
                    </tr>
                    <tr class="table-header text-center">
                      <th rowspan="2">Specimen/Status</th>
                      <th colspan="4">STATUSES</th>
                    </tr>
                    <tr class="table-header text-center">
                      <th>Ordered</th>
                      <th>Completed</th>
                      <th>In Progress</th>
                      <th>% Completed</th>
                    </tr>
                    <tr *ngFor="let specimen of specimenSources">
                      <td>
                        {{ specimen }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.ordered[specimen]
                            ?.length
                        }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.performed[specimen]
                            ? reportData["bySpecimenSouces"]?.performed[
                                specimen
                              ]?.length
                            : 0
                        }}
                      </td>
                      <td>
                        {{
                          reportData["bySpecimenSouces"]?.ordered[specimen]
                            ?.length -
                            (reportData["bySpecimenSouces"]?.performed[specimen]
                              ? reportData["bySpecimenSouces"]?.performed[
                                  specimen
                                ]?.length
                              : 0)
                        }}
                      </td>
                      <td>
                        {{
                          (
                            ((reportData["bySpecimenSouces"]?.performed[
                              specimen
                            ]
                              ? reportData["bySpecimenSouces"]?.performed[
                                  specimen
                                ]?.length
                              : 0) /
                              reportData["bySpecimenSouces"]?.ordered[specimen]
                                ?.length) *
                            100
                          ).toFixed(1)
                        }}
                      </td>
                    </tr>

                    <tr>
                      <td colspan="5"></td>
                    </tr>
                  </ng-container>

                  <ng-container
                    *ngIf="currentReport?.id == 'tests-by-departments'"
                  >
                    <tr class="table-header text-center">
                      <th colspan="5">Tests by Departments</th>
                    </tr>
                    <tr class="table-header text-center">
                      <th>Department</th>
                      <th>Ordered</th>
                      <th>Completed</th>
                      <th colspan="2">In Progress</th>
                    </tr>
                    <ng-container *ngFor="let department of departments">
                      <tr>
                        <td
                          [attr.rowspan]="
                            reportData['bySpecimenSouces']?.ordered[specimen]
                              ?.length
                          "
                        >
                          {{ department }}
                        </td>
                        <td>
                          {{ groupedByDeptDataObject[department]["all"] }}
                        </td>
                        <td>
                          {{ groupedByDeptDataObject[department]["completed"] }}
                        </td>
                        <td colspan="2">
                          {{ groupedByDeptDataObject[department]["progress"] }}
                        </td>
                      </tr>
                    </ng-container>
                    <tr>
                      <td>Total</td>
                      <td>{{ Totals["all"] }}</td>
                      <td>{{ Totals["completed"] }}</td>
                      <td colspan="2">{{ Totals["progress"] }}</td>
                    </tr>
                  </ng-container>
                  <ng-container
                    *ngIf="currentReport?.id == 'grouped-tests-performed'"
                  >
                    <tr class="table-header text-center">
                      <th colspan="5">Tests by names</th>
                    </tr>
                    <tr class="table-header text-center">
                      <th>Specimen</th>
                      <th>Ordered</th>
                      <th>Performed</th>
                      <th colspan="2">In Progress</th>
                    </tr>
                    <ng-container
                      *ngFor="
                        let specimen of specimenSources;
                        let count = index
                      "
                    >
                      <tr
                        *ngFor="
                          let test of reportData['groupedByTestsAndSpecimen']
                            ?.ordered[specimen];
                          let i = index
                        "
                      >
                        <td
                          *ngIf="i == 0"
                          [attr.rowspan]="
                            reportData['groupedByTestsAndSpecimen']?.ordered[
                              specimen
                            ]?.length
                          "
                        >
                          {{ specimen }}
                        </td>
                        <td>
                          {{ test?.test }}
                        </td>
                        <td>
                          {{
                            reportData["performedKeyValuePair"][
                              specimen + "-" + test?.test
                            ]
                              ? reportData["performedKeyValuePair"][
                                  specimen + "-" + test?.test
                                ]?.length
                              : 0
                          }}
                        </td>
                        <td colspan="2">
                          {{
                            reportData["processingKeyValuePair"][
                              specimen + "-" + test?.test
                            ]
                              ? reportData["processingKeyValuePair"][
                                  specimen + "-" + test?.test
                                ]?.length
                              : "N/A"
                          }}
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                </table>
              </div>
            </div>
            <div *ngIf="currentReport?.id == 'SamplesRejected' && reportData">
              <div>
                <table class="table table-bordered" id="export-table">
                  <thead class="table-header">
                    <tr>
                      <th>MRN</th>
                      <th>Patient</th>
                      <th>Sample No</th>
                      <th>Sample Date</th>
                      <th>Test</th>
                      <th>Rejection Reason</th>
                      <th>Rejection Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let rejectedSample of reportData">
                      <td>
                        {{ rejectedSample?.MRN }}
                      </td>
                      <td>
                        {{ rejectedSample?.patient }}
                      </td>
                      <td>
                        {{ rejectedSample?.sampleNo }}
                      </td>
                      <td>
                        {{ rejectedSample?.sampleCollected | date: "medium" }}
                      </td>
                      <td>
                        {{ rejectedSample?.testName }}
                      </td>
                      <td>
                        {{ rejectedSample?.reason }}
                      </td>
                      <td>
                        {{ rejectedSample?.dateRejected | date: "medium" }}
                      </td>
                    </tr>

                    <tr *ngIf="reportData?.length == 0">
                      <td colspan="7" class="text-center">
                        No rejected Samples for the selected time period
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="currentReport?.id == 'Malaria' && reportData">
              <div>
                <table class="table" id="export-table">
                  <thead class="table-header">
                    <tr>
                      <th *ngFor="let reportHeader of reportData?.reportHeades">
                        {{ reportHeader?.name }}
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let row of reportData?.headers">
                      <td *ngFor="let reportHeader of reportData?.reportHeades">
                        {{
                          reportData?.data[row?.index][reportHeader?.id]?.value
                        }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div *ngIf="currentReport?.id == 'PatientsAttended' && reportData">
              <div>
                <table class="table" id="export-table">
                  <thead class="table-header">
                    <tr>
                      <th>SN</th>
                      <th>MRN</th>
                      <th>Name</th>
                      <th>Age</th>
                      <th>Gender</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let patient of reportData; let count = index">
                      <td>{{ count + 1 }}</td>
                      <td>{{ patient?.identifier }}</td>
                      <td>{{ patient?.name }}</td>
                      <td>{{ patient?.age }}</td>
                      <td>{{ patient?.gender }}</td>
                      <td>
                        <button
                          mat-raised-button
                          color="basic"
                          [disabled]="
                            !(
                              resultsLoader[patient?.visit] &&
                              resultsLoader[patient?.visit]['loading']
                            ) && resultsLoader['disableRestOfRows']
                          "
                          (click)="
                            onResultsToPrint(
                              $event,
                              patient?.visit,
                              params?.providerDetails,
                              params?.sampleTypes,
                              params?.labSamplesAndTestsContainers,
                              params?.labSamplesDepartments,
                              params?.codedSampleRejectionReasons,
                              labConfigs
                            )
                          "
                        >
                          <span
                            *ngIf="
                              resultsLoader[patient?.visit] &&
                              resultsLoader[patient?.visit]['loading']
                            "
                          >
                            Processing Results
                          </span>
                          <mat-progress-bar
                            *ngIf="
                              resultsLoader[patient?.visit] &&
                              resultsLoader[patient?.visit]['loading']
                            "
                            mode="buffer"
                          ></mat-progress-bar>
                          <span
                            *ngIf="
                              !(
                                resultsLoader[patient?.visit] &&
                                resultsLoader[patient?.visit]['loading']
                              )
                            "
                            >Print Results</span
                          >
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div
              *ngIf="
                currentReport?.parent == 'tests-analysis' &&
                currentReport?.id == 'tests-analysis-report' &&
                reportData
              "
            >
              <div>
                <table class="table" id="export-table">
                  <thead class="table-header">
                    <tr>
                      <th>Department</th>
                      <th>Test</th>
                      <th>Number of Tests</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let test of reportData; let count = index">
                      <td>{{ test?.dep_nm }}</td>
                      <td>{{ test?.test }}</td>
                      <td>{{ test?.count }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!currentReport?.hardCoded">
          <div class="row" *ngIf="facilityDetails$ | async as facility">
                <div class="col-2" style="display: inline-block; width: 16.67%">
                  <img src="assets/images/udsm-logo.webp" height="90" />
                  <!-- <img src="assets/images/tanzania-logo.png" height="90" /> -->
                </div>
                <div class="col-8" style="display: inline-block; width: 66.67%">
                  <h4 style="text-align: center">
                    <b
                      >United Republic of Tanzania. <br />
                      Ministry of Health.
                      <br />
                     <!-- <span *ngIf="labConfigs?.facilityDetails">
                        {{ labConfigs?.facilityDetails?.name }}<br />
                      </span> -->
                      <span *ngIf="facility.display">
                        {{ facility.display }}<br />
                      </span>
                     <small>
                    <!-- <span
                      *ngIf="
                        labConfigs?.facilityDetails &&
                        labConfigs?.facilityDetails?.addressBox
                      ">P.O BOX: {{ labConfigs?.facilityDetails?.addressBox }}</span> -->
                        <span
                          *ngIf="
                            facility &&
                            facility.postalCode
                          "
                        >
                          P.O BOX: {{ facility.postalCode }}
                        </span>
                        <!-- <span
                          *ngIf="
                            labConfigs?.facilityDetails &&
                            labConfigs?.facilityDetails?.addressTel
                          "
                        >
                          TEL: {{ labConfigs?.facilityDetails?.addressTel }}
                        </span>  -->
                        </small
                      ><br />
                      <small>
                        <span
                          *ngIf="
                            facility &&
                            facility.stateProvince
                          "
                        >
                          {{ facility.stateProvince }}
                        </span>
                        <!-- <span
                          *ngIf="
                            labConfigs?.facilityDetails &&
                            labConfigs?.facilityDetails?.addressLocaton
                          "
                        >
                          {{ labConfigs?.facilityDetails?.addressLocaton }}
                        </span> -->
                      </small>
                    </b>
                  </h4>
                </div>
              </div>
          <div class="header text-center h3 p-3">
            {{ currentReport?.name }}
          </div>
          <div *ngIf="selectionDates && dateChanged">
            <app-custom-reports
              [report]="currentReport"
              [selectionDates]="selectionDates"
            ></app-custom-reports>
          </div>
        </div>
      </mat-card>
    </div>
  </div>
</div>
